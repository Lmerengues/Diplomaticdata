<!DOCTYPE html>
<html>
<head>
  <title>人际关系查询</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style type="text/css">
    html, body {
      font: 10pt arial;
    }
    #mynetwork {
      width: 600px;
      height: 600px;
      border: 1px solid lightgray;
    }
    #mytable td{
        padding:10px 18px
    }
    #mytable tr:hover {  
    background-color: #0180FE;  
    color: #fff;  
    cursor:hand;  
    }
  
.dataTable tr:hover td {background:none;}
  </style>

    <script type="text/javascript" src="static/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="static/dist/vis.js"></script>
    <script type="text/javascript" src="static/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
    <script type="text/javascript" src="static/js/bootstrap-slider.js"></script>
    <script type="text/javascript" src="static/js/jquery.dataTables.min.js"></script>
    <link href="static/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
    <link  href="static/bootstrap-3.3.7-dist/css/bootstrap.css" rel="stylesheet">
    <link  href="static/bootstrap-3.3.7-dist/css/bootstrap-theme.css" rel="stylesheet">
    <link  href="static/css/slider.css" rel="stylesheet">
    <link  href="static/css/jquery.dataTables.min.css" rel="stylesheet">
</head>

<body onload="draw()">
    <div class="row" style="">
		<div class="span6">
			<ul class="nav nav-tabs" style="margin-left:1%;">
				<li class="active">
					<a href="near.html">人际关系查询</a> </li>
                <li><a href="path.html?id=扎克伯格&卡扎菲">六度查询</a></li>
			</ul>
		</div>
	</div>
    <hr>
     <div id="main-container" class="container" style="margin-left: 0;padding-left:0px;">
        <div class="row">
            <div class="col-md-8 col-sm-12 col-xs-12">
                <div class="panel panel-default">
                        <div class="panel-heading">
                            <form action="/find_near" method="get">
                                <div class="row">
                                    <div class="col-lg-3 col-sm-3">
                                        <input type="text" class="form-control" name="htitle" id="pname" name="p" placeholder="姓名">
                                        <div class="errormessage"></div>
                                    </div>
                                    <div class="col-lg-3 col-sm-3">
                                        <label for="ex1">最大邻居个数：</label>
                                        <input id="ex1" data-slider-id='ex1Slider' name="maxnear" type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="14"/>
                                    </div>
                                    <div class="col-lg-3 col-sm-3">
                                        <label for="ex1">是否显示邻居间关系：</label></br>
                                            <input type="radio" name="optionsRadios" id="optionsRadios1" value="1" checked> 是
                                            <input type="radio" name="optionsRadios" id="optionsRadios2" value="2">否
                                    </div>
                                    <div class="col-lg-2 col-sm-3">
                                        <input type="button" class="btn btn-default" style="margin-left:5px" name="Submit" value="查询" id='btn-commit' />
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="panel-body">
                            <div id="mynetwork" class="center-block" style="width:100%"></div>
                        </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-12 col-xs-12" >
                <div class="panel panel-default" style="">
                    <div class="panel-heading">
                        <a class="btn btn-success"></a>
                    </div>
                    <div class="panel-body" style="" id="resultbody">
                        <div id="result">
                            <h3><span id="resulttitle">的人际关系</span></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
     </div>
    <input type="hidden" id="hid" value="14"></input>

    <script type="text/javascript">
        var nodes = [];
        var edges = [];
        var network = null;
        var maxn = 14;
        $(document).ready(function(){
            slide = $('#ex1').slider({
                formatter: function(value) {
                    maxn = value;
                return 'Current value: ' + value;
                }
            });
            $("#ex1").on("slide", function(slideEvt) {
                $("#hid").val(slideEvt.value);
            });
            $("#btn-commit").click(function(){
                var name = $("#pname").val();
                if(name==""){
                    alert("请输入一个人的姓名！");
                    return ;
                }
                len = name.split("&").length;
                if(len>1){
                    if(name.split("&")[0]==""&&name.split("&")[1]!=""){
                        location.href="near.html?name="+name.split("&")[1];
                        return ;
                    }
                    else if(name.split("&")[1]==""&&name.split("&")[0]!=""){
                        location.href="near.html?name="+name.split("&")[0];
                        return ;
                    }
                    else{
                        window.location.href="path.html?ids="+name.split("&")[0]+"&"+name.split("&")[1];
                        return ;
                    }
                }
                nodes = [];
                edges = [];
                network = [];
                $("#resulttitle").html(name+"的人际关系")
                var maxnear = $("#ex1").val();
                snode = {id:name,label:name,color:{background:"#ff9966"}};
                nodes.push(snode);
                maxn = $("#hid").val();
                var mr = 1;
                if($("#optionsRadios1").is(":checked")){
                    mr = 0
                }
                $.get("http://127.0.0.1:8000/find_near",{'pname':name,'maxnear':maxn,'mr':mr}, function(ret){
                    str = "<h3><span id='resulttitle'></span></h3><table class='table table-striped table-hover ' style='width:100%' id='mytable'><thead><th>姓名</th><th>亲密度</th></thead><tbody>";
                    if(ret.length==0){
                        alert("没有找到这个人的信息，输一个我知道的人吧！");
                        return ;
                    }
                    for(var i in ret){
                        if(ret[i]["end.name"] == name) continue;
                        node = {id:ret[i]["end.name"],label:ret[i]["end.name"]};
                        edge = {from:ret[i]['n.name'],to:ret[i]["end.name"],value:ret[i]["r.value"],title:ret[i]["r.value"]}
                        if(ret[i]['n.name'] == name){
                            nodes.push(node)
                            str += "<tr><td>"+ ret[i]['end.name']+"</td>"+"<td>"+ret[i]["r.value"]+"</td>"+"</tr>"
                        }
                        edges.push(edge)

                    }
                    str += "</tbody></table>"
                    draw();
                    $("#result").html(str);
                    $("#resulttitle").html(name+"的人际关系");
                    var table = 
                    $('#mytable').DataTable({
                        "paging": true,
                        "iDisplayLength": 12, //默认每页数量
                        "bPaginate": true, //翻页功能
                        "bLengthChange": false, //改变每页显示数据数量
                        "bFilter": false, //过滤功能
                        "bInfo": true, //页脚信息
                        "bAutoWidth": true, //自动宽度
                        "bRetrieve": true,
                        "processing": true,
                        //"ordering": false,
                        "bSort": false,
                        //"serverSide" : true,//服务器端进行分页处理的意思
                        //"bPaginate": true,
                        //"bProcessing": true
                        columns : [{data : "id"},{data:"value"}],
                    });
                    $("#mytable").on("click","tr",function()
                    {//给tr或者td添加click事件
                        var data=table.row(this).data();//获取值的对象数据
                        console.log(data);//某一行中要是用的表头值
                        //draw();
                        console.log("draw");

                    console.log(nodes);
                    });
                })
            });

            if(window.location.href.split("=").length>1){
                id = window.location.href.split("=")[1];
                id = decodeURI(id);
                $("#pname").val(id);
                $('#btn-commit').trigger("click");
            }
            else{
                $("#pname").val("李克强");
                $('#btn-commit').trigger("click");
            }
        });
        function draw() 
        {
            var container = document.getElementById('mynetwork');
            var data = {
                nodes: nodes,
                edges: edges
            };
            var options = {
                nodes: {
                    shape: 'dot',
                    scaling:{
                        label: {
                        min:8,
                        max:20
                        }
                    },
                    color:{
                        highlight: {//节点选中时状态颜色
                            background: '#ec7171',
                            border: '#f90909'
                        },
                    },
                },
                layout:{
                    randomSeed:1,//配置每次生成的节点位置都一样，参数为数字1、2等
                },
            };
            network = new vis.Network(container, data, options);

            network.on("doubleClick", function(params) {//双击事件
                if (params.nodes.length != 0) {//确定为节点双击事件
                    var click_node_id = params.nodes[0];
                    params.nodes[0]
                    //remove_all_sub_nodes(click_node_id);
                    //console.log(click_node_id);
                    $("#pname").val(click_node_id);
                    $("#btn-commit").trigger("click");
                }
             });

        }

        
    </script>
</body>
</html>